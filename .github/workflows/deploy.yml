---
name: ğŸ‘· Deploy to Other Projects

on:
    workflow_run:
        workflows:
            - 'Release'
        types:
            - completed

permissions:
    contents: write

env:
    tag: ${{ github.event.head_commit.id }}

jobs:
    copy-file-to-app:
        runs-on: ubuntu-latest
        steps:
            - name: å½“å‰ç›®å½•
              run: pwd
            - name: ä¸‹è½½ JuiceNote
              uses: actions/checkout@v4
              with:
                  repository: CofficLab/JuiceNote
                  token: ${{ secrets.Token_Sync }}
                  ref: dev
            - name: æ£€æŸ¥æ–‡ä»¶
              run: ls -alh
            - name: åˆ é™¤æ—§ç‰ˆ
              run: rm -rf Resources/dist
            - name: ä¸‹è½½æ„ä»¶
              uses: actions/download-artifact@v4
              with:
                  name: dist
                  path: Resources/dist
            - name: æ£€æŸ¥
              run: ls -alh Resources/dist
            - name: ä¸‹è½½ç‰ˆæœ¬æ„ä»¶
              uses: actions/download-artifact@v4
              with:
                  name: version
                  path: temp
            - name: æ£€æŸ¥
              run: ls -alh temp
            - name: æ¨é€
              run: |
                  version=$(cat temp/version.txt)
                  echo $version
                  rm -rf temp

                  if [ -z "$(git status -s)" ]; then
                    echo "Working tree is clean."
                  else
                    git config --global user.name "GitHub Action of Kuaiyizhi_Editor"
                    git config --global user.email "action@github.com"
                    git add .
                    git commit -m "ğŸ‘· CI: Update editor to ${version}"
                    git push origin dev
                  fi

    copy-file-to-app-flutter:
        runs-on: ubuntu-latest
        steps:
            - name: å½“å‰ç›®å½•
              run: pwd
            - name: ä¸‹è½½ Kuaiyizhi_Flutter
              uses: actions/checkout@v4
              with:
                  repository: CofficLab/Kuaiyizhi_Flutter
                  token: ${{ secrets.Token_Sync }}
                  ref: dev
            - name: æ£€æŸ¥æ–‡ä»¶
              run: ls -alh
            - name: åˆ é™¤æ—§ç‰ˆ
              run: rm -rf assets/editor
            - name: ä¸‹è½½æ„ä»¶
              uses: actions/download-artifact@v4
              with:
                  name: dist
                  path: assets/editor
            - name: æ£€æŸ¥
              run: ls -alh assets/editor
            - name: ä¸‹è½½ç‰ˆæœ¬æ„ä»¶
              uses: actions/download-artifact@v4
              with:
                  name: version
                  path: temp
            - name: æ£€æŸ¥
              run: ls -alh temp
            - name: æ¨é€
              run: |
                  version=$(cat temp/version.txt)
                  echo $version
                  rm -rf temp

                  if [ -z "$(git status -s)" ]; then
                    echo "Working tree is clean."
                  else
                    git config --global user.name "GitHub Action of Kuaiyizhi_Editor"
                    git config --global user.email "action@github.com"
                    git add .
                    git commit -m "ğŸ‘· CI: Update editor to ${version}"
                    git push origin dev
                  fi

    copy-file-to-demo:
        runs-on: ubuntu-latest
        steps:
            - name: å½“å‰ç›®å½•
              run: pwd
            - name: ä¸‹è½½ JuiceEditor-Demo
              uses: actions/checkout@v4
              with:
                  repository: CofficLab/JuiceEditor-Demo
                  token: ${{ secrets.Token_Sync }}
                  ref: main
            - name: æ£€æŸ¥æ–‡ä»¶
              run: ls -alh
            - name: åˆ é™¤æ—§ç‰ˆ
              run: rm -rf public/juice-editor
            - name: ä¸‹è½½æ„ä»¶
              uses: actions/download-artifact@v4
              with:
                  name: dist
                  path: public/juice-editor
            - name: æ£€æŸ¥
              run: ls -alh public/juice-editor
            - name: ä¸‹è½½ç‰ˆæœ¬æ„ä»¶
              uses: actions/download-artifact@v4
              with:
                  name: version
                  path: temp
            - name: æ£€æŸ¥
              run: ls -alh temp
            - name: æ¨é€
              run: |
                  version=$(cat temp/version.txt)
                  echo $version
                  rm -rf temp

                  if [ -z "$(git status -s)" ]; then
                    echo "Working tree is clean."
                  else
                    git config --global user.name "GitHub Action of JuiceEditor"
                    git config --global user.email "action@github.com"
                    git add .
                    git commit -m "ğŸ‘· CI: Update editor to ${version}"
                    git push origin main
                  fi

    clear:
        needs:
            - copy-file-to-app
            - copy-file-to-app-flutter
            - copy-file-to-demo
        runs-on: ubuntu-latest
        permissions:
            actions: write
        steps:
            - name: å½“å‰ç”¨æˆ·
              run: whoami
            - name: æ¸…ç†æ„ä»¶
              uses: geekyeggo/delete-artifact@v4
              with:
                  token: ${{ github.token }}
                  name: |
                      dist
                      version
