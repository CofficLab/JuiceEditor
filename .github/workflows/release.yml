---
name: Release

on:
    push:
        branches: [main]
        tags:
            - '*'

permissions:
    contents: write

env:
    tag: ${{ github.event.head_commit.id }}

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - name: å½“å‰ç”¨æˆ·
              run: whoami
            - name: Checkout
              uses: actions/checkout@v4
            - name: NPM ç‰ˆæœ¬
              run: npm -v
            - name: å®‰è£…PNPM
              run: npm i -g pnpm
            - name: NPM å®‰è£…
              run: pnpm i
            - name: NPM æ„å»º
              run: npm run build
            - name: ä¸Šä¼ æ„ä»¶
              uses: actions/upload-artifact@v4
              with:
                  name: dist
                  path: dist
                  retention-days: 1

    tag:
        needs: [build]
        runs-on: ubuntu-latest
        steps:
            - name: å½“å‰ç”¨æˆ·
              run: whoami
            - uses: actions/checkout@v4
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
            - name: ç”Ÿæˆæ ‡ç­¾
              run: |
                  git config --global user.name "GitHub Action"
                  git config --global user.email "action@github.com"
                  npm version patch -m "ğŸ‘· CI: Upgrade to v%s"
                  git push origin main --tags
            - name: è¯»å–ç‰ˆæœ¬ï¼Œå†™å…¥æ–‡ä»¶
              run: |
                  version=$(node -p "require('./package.json').version")
                  echo $version
                  echo "${version}" >> version.txt
            - name: ä¸Šä¼ æ„ä»¶
              uses: actions/upload-artifact@v4
              with:
                  name: version
                  path: version.txt
                  retention-days: 1

    rebase_dev:
        needs:
            - tag
        runs-on: ubuntu-latest
        steps:
            - name: æ‹‰å– dev åˆ†æ”¯
              uses: actions/checkout@v3
              with:
                  ref: dev
            - name: Rebase dev on main
              continue-on-error: true
              run: git rebase origin/main
            - name: Push the rebased dev branch
              continue-on-error: true
              run: git push origin dev

    release:
        runs-on: ubuntu-latest
        needs: [tag]
        steps:
            - uses: actions/checkout@v4
            - name: ä¸‹è½½ç‰ˆæœ¬æ„ä»¶
              uses: actions/download-artifact@v4
              with:
                  name: version
                  path: temp
            - run: ls -alhR
            - name: è¯»å–ç‰ˆæœ¬å·
              run: |

                  version=$(cat temp/version.txt)
                  echo $version

                  # å†™å…¥ç¯å¢ƒå˜é‡
                  echo "tag=v$version" >> $GITHUB_ENV
            - uses: softprops/action-gh-release@v1
              with:
                  tag_name: ${{ env.tag }}
                  files: |
                      ./**/*.dmg
                      ./**/*.zip
                      ./**/*.exe
                      ./**/*.pkg
                      ./**/*.deb
                      ./**/*.ipa
                      ./**/*.AppImage
                      ./**/*.snap

    clear:
        needs:
            - release
        runs-on: ubuntu-latest
        permissions:
            actions: write
        steps:
            - name: å½“å‰ç”¨æˆ·
              run: whoami
            - name: æ¸…ç†æ„ä»¶
              uses: geekyeggo/delete-artifact@v4
              with:
                  token: ${{ github.token }}
                  name: |
                      dist
                      version
